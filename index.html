<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Record â†’ Auto Copy (Diagnose & Fallback)</title>
<style>
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto; padding:16px }
  .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 }
  button { padding:10px 14px; border:0; border-radius:10px; background:#007aff; color:#fff; font-size:16px }
  #timer { min-width:80px; font-variant-numeric:tabular-nums }
  #meter { width:160px; height:10px; background:#eee; border-radius:999px; overflow:hidden }
  #bar { height:100%; width:0; background:#34c759 }
  #log { font-size:12px; color:#666; white-space:pre-wrap; margin-top:6px }
  #b64,#dataurl{ position:fixed; bottom:-9999px; left:0; width:1px; height:1px; opacity:.001 }
  select { padding:8px; border-radius:8px; border:1px solid #ccc; font-size:14px }
</style>
</head>
<body>
  <h2>ì˜¤ë””ì˜¤ ë…¹ìŒ (ì§„ë‹¨/í´ë°±)</h2>

  <div class="row">
    <button id="recordBtn">Record</button>
    <span id="timer">00:00</span>
    <div id="meter"><div id="bar"></div></div>
    <select id="inputSelect" hidden></select>
  </div>

  <div id="log"></div>

  <!-- ë°±ì—…/í´ë°± -->
  <textarea id="b64" readonly></textarea>
  <textarea id="dataurl" readonly></textarea>

<script>
(() => {
  const recordBtn = document.getElementById('recordBtn');
  const timerEl   = document.getElementById('timer');
  const barEl     = document.getElementById('bar');
  const logEl     = document.getElementById('log');
  const inputSel  = document.getElementById('inputSelect');
  const b64TA     = document.getElementById('b64');
  const dataTA    = document.getElementById('dataurl');

  let mediaRecorder=null, chunks=[], startTs=0, tickId=0;
  let stream=null, meterRAF=0, audioCtx=null, analyser=null;

  const fmt = ms => { const s=Math.floor(ms/1000), m=String(Math.floor(s/60)).padStart(2,'0'), ss=String(s%60).padStart(2,'0'); return `${m}:${ss}`; };
  const log = (...a)=>{ logEl.textContent = a.join(' ') + '\n' + logEl.textContent; };

  async function copyTextRobust(text){
    try{
      if ((location.protocol==='https:'||['localhost','127.0.0.1'].includes(location.hostname))
          && navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text); return true;
      }
    }catch(e){}
    try{
      const ta=document.createElement('textarea');
      ta.value=text; ta.setAttribute('readonly','');
      ta.style.position='fixed'; ta.style.left='0'; ta.style.bottom='0'; ta.style.opacity='0.001';
      document.body.appendChild(ta); ta.focus(); ta.select(); ta.setSelectionRange(0, ta.value.length);
      const ok=document.execCommand('copy'); document.body.removeChild(ta);
      if (ok) return true;
    }catch(e){}
    b64TA.value=text; b64TA.focus(); b64TA.select(); b64TA.setSelectionRange(0,b64TA.value.length);
    return document.execCommand('copy');
  }

  function pickRecorderMime(){
    const cands = [
      'audio/mp4;codecs=mp4a.40.2', // m4a ìš°ì„ 
      'audio/mp4',
      'audio/webm;codecs=opus',
      'audio/webm'
    ];
    for (const m of cands){
      if (window.MediaRecorder?.isTypeSupported?.(m)) return m;
    }
    return ''; // ë¸Œë¼ìš°ì € ê¸°ë³¸
  }

  function blobToDataURL(blob){
    return new Promise((res,rej)=>{
      const fr=new FileReader();
      fr.onload=()=>res(fr.result);
      fr.onerror=rej;
      fr.readAsDataURL(blob);
    });
  }

  // ğŸšï¸ ì‹¤ì‹œê°„ ì…ë ¥ ë ˆë²¨ ë¯¸í„° (ë“¤ì–´ì˜¤ë©´ ë°”ê°€ ì¶œë ì—¬ì•¼ ì •ìƒ)
  function startMeter(s){
    if (meterRAF) cancelAnimationFrame(meterRAF);
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const src = audioCtx.createMediaStreamSource(s);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    const data = new Uint8Array(analyser.fftSize);
    src.connect(analyser);

    const tick = ()=>{
      analyser.getByteTimeDomainData(data);
      let sum=0;
      for (let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum+=v*v; }
      const rms = Math.sqrt(sum/data.length);         // 0~1
      const pct = Math.min(100, Math.max(0, Math.round(rms*200)));
      barEl.style.width = pct + '%';
      meterRAF = requestAnimationFrame(tick);
    };
    tick();
  }

  function stopMeter(){
    if (meterRAF) cancelAnimationFrame(meterRAF), meterRAF=0;
    if (audioCtx) { audioCtx.close(); audioCtx=null; }
    barEl.style.width = '0%';
  }

  async function getStream(deviceId){
    const constraints = {
      audio: {
        deviceId: deviceId ? { exact: deviceId } : undefined,
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: false
      }
    };
    return await navigator.mediaDevices.getUserMedia(constraints);
  }

  async function prepareDevices(){
    try{
      const list = await navigator.mediaDevices.enumerateDevices();
      const inputs = list.filter(d=>d.kind==='audioinput');
      if (inputs.length > 1) {
        inputSel.hidden = false;
        inputSel.innerHTML = inputs.map(d=>`<option value="${d.deviceId}">${d.label||'ë§ˆì´í¬'}</option>`).join('');
        inputSel.onchange = async ()=>{
          if (stream){ stream.getTracks().forEach(t=>t.stop()); stopMeter(); }
          stream = await getStream(inputSel.value);
          startMeter(stream); // ì„ íƒ ì¦‰ì‹œ ë ˆë²¨ í™•ì¸
        };
      }
      log('Inputs:', inputs.map(d=>d.label||d.deviceId).join(', ') || '1ê°œ ë¯¸ë§Œ');
    }catch(e){ log('enumerateDevices ì‹¤íŒ¨:', e.message); }
  }

  async function startRec(){
    if (!navigator.mediaDevices?.getUserMedia){
      alert('ì´ í™˜ê²½ì—ì„œëŠ” ë§ˆì´í¬ ì ‘ê·¼ì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. HTTPS ë˜ëŠ” localhostì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.'); return;
    }

    // ì²« ìŠ¤íŠ¸ë¦¼ í™•ë³´(ì„ íƒëœ ê¸°ê¸° ìš°ì„ )
    if (!stream) stream = await getStream(inputSel.value);

    // ğŸ” ë ˆë²¨ ë¯¸í„°ë¡œ ì¦‰ì‹œ ì…ë ¥ í™•ì¸ (ë§í•˜ë©´ ë°”ê°€ ì›€ì§ì—¬ì•¼ ì •ìƒ)
    startMeter(stream);

    // Safari ì´ˆê¸° ë“œë¡­ ë°©ì§€: 500ms ì•ˆì •í™”
    await new Promise(r=>setTimeout(r,500));

    chunks=[];
    const mt = pickRecorderMime(); // ì•ˆì „ í´ë°±
    try {
      mediaRecorder = mt ? new MediaRecorder(stream, { mimeType: mt }) : new MediaRecorder(stream);
    } catch(e) {
      log('MediaRecorder ìƒì„± ì‹¤íŒ¨, ê¸°ë³¸ìœ¼ë¡œ ì¬ì‹œë„:', e.message);
      mediaRecorder = new MediaRecorder(stream);
    }
    log('Recorder MIME:', mediaRecorder.mimeType || '(browser default)');

    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };

    mediaRecorder.onstop = async () => {
      clearInterval(tickId); timerEl.textContent='00:00';
      stopMeter();

      const type = mediaRecorder.mimeType || 'audio/mp4';
      const blob = new Blob(chunks, { type });
      log('Blob type:', type, 'size:', blob.size);

      // ğŸ”Š í”Œë ˆì´ì–´ëŠ” ë…¹ìŒ í›„ì—ë§Œ ìƒì„± (ë£¨í”„ë°± ë°©ì§€)
      const player = document.createElement('audio');
      player.controls = true;
      player.src = URL.createObjectURL(blob);
      player.style.display='block';
      player.style.marginTop='12px';
      document.body.appendChild(player);

      // ğŸ“‹ ìë™ ë³µì‚¬ (data:audio/...;base64,...)
      const dataURL = await blobToDataURL(blob);
      dataTA.value = dataURL;
      await copyTextRobust(dataURL);

      // ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ
      if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    };

    startTs = Date.now();
    tickId  = setInterval(()=> timerEl.textContent = fmt(Date.now()-startTs), 250);
    mediaRecorder.start(250);               // 250ms chunk â†’ ë©”ëª¨ë¦¬/ì•ˆì •ì„± â†‘
    recordBtn.textContent='Stop';
  }

  function stopRec(){
    if (!mediaRecorder) return;
    mediaRecorder.stop();
    recordBtn.textContent='Record';
  }

  recordBtn.addEventListener('click', async ()=>{
    if (mediaRecorder && mediaRecorder.state==='recording') stopRec();
    else {
      try {
        await startRec();
      } catch(e){
        log('startRec ì‹¤íŒ¨:', e.message);
        alert('ë§ˆì´í¬ ê¶Œí•œ ë˜ëŠ” ì¥ì¹˜ ì„ íƒ ë¬¸ì œë¡œ ì‹œì‘í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\nâ€¢ HTTPS/localhostì¸ì§€ í™•ì¸\nâ€¢ ì„¤ì • > Safari > ë§ˆì´í¬ í—ˆìš©\nâ€¢ í•„ìš”ì‹œ ë‹¤ë¥¸ ì…ë ¥ ì¥ì¹˜ ì„ íƒ');
      }
    }
  });

  // ìµœì´ˆ ì§„ë‹¨: ì¥ì¹˜ ëª©ë¡ ê°±ì‹ 
  prepareDevices().catch(()=>{});

  if (!(location.protocol==='https:' || ['localhost','127.0.0.1'].includes(location.hostname))) {
    log('ê²½ê³ : HTTPS/localhostê°€ ì•„ë‹ˆë©´ ë§ˆì´í¬/í´ë¦½ë³´ë“œê°€ ì°¨ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  }
})();
</script>
</body>
</html>
